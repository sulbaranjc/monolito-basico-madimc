<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>MEDIMIC ‚Äî Listar pacientes</title>

  <!-- CSS global -->
  <link rel="stylesheet" href="{{ url_for('static', path='css/main.css') }}?v={{ range(1000000) | random }}">
  
  <!-- CSS espec√≠fico de esta vista -->
  <link rel="stylesheet" href="{{ url_for('static', path='css/patients_list.css') }}?v={{ range(1000000) | random }}">
</head>
<body>
  <!-- Componente Header -->
  {% include "components/header.html" %}

  <main class="container">
    <h2>Listado de Pacientes</h2>

    <div class="actions-bar">
      <a class="btn-primary" href="/patients/create">Agregar paciente</a>
    </div>

    {% if patients and patients|length %}
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Fecha nac.</th>
              <th>Sexo</th>
              <th>Email</th>
              <th>Tel√©fono</th>
              <th>IMC</th>
              <th>Categor√≠a</th>
              <th class="col-actions">Acciones</th>
            </tr>
          </thead>
          <tbody>
    {% for p in patients %}
      <tr>
        <td>{{ p.computed.display_name }}</td>
        <td>{{ p.date_of_birth or "‚Äî" }}</td>
        <td>{{ p.sex_at_birth or "‚Äî" }}</td>
        <td>{{ p.email or "‚Äî" }}</td>
        <td>{{ p.phone or "‚Äî" }}</td>
        <td>
          {% if p.bmi_last is not none %}
            {{ "%.2f"|format(p.bmi_last) }}
          {% else %}
            ‚Äî 
          {% endif %}
        </td>
        <td>{{ p.bmi_category_last or "‚Äî" }}</td>
        <td class="actions-cell">
          {# ‚úèÔ∏è Bot√≥n Modificar (nuevo) #}
          <a class="btn-secondary" href="/patients/{{ p.patient_id }}/edit">
            Modificar
          </a>

          {# üóëÔ∏è Bot√≥n Eliminar con confirmaci√≥n JS #}
          <form
            action="/patients/{{ p.patient_id }}/delete"
            method="post"
            class="inline-form"
            onsubmit="return confirmDelete(this)"
            data-display-name="{{ p.computed.display_name }}">
            <button type="submit" class="btn-danger">Eliminar</button>
          </form>
        </td>
      </tr>
    {% endfor %}
  </tbody>

        </table>
      </div>
    {% else %}
      <p>No hay pacientes para mostrar.</p>
    {% endif %}
  </main>

  <!-- Componente Footer -->
  {% include "components/footer.html" %}

  <!-- JS por vista (cache-bust din√°mico para evitar versionado en dev) -->
  <script>
    (function(){
      const s = document.createElement('script');
      s.src = "{{ url_for('static', path='js/patients_list.js') }}" + '?v=' + Date.now();
      // Cargar de forma no-asincr√≥nica para asegurar que la funci√≥n global
      // `confirmDelete` est√© disponible antes de cualquier submit/onsubmit.
      s.async = false;
      document.body.appendChild(s);
    })();
  </script>
</body>
</html>