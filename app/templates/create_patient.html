{% extends "layout.html" %}
{% block title %}MEDIMIC — Crear paciente{% endblock %}

{% block content %}
  <h2>Crear paciente</h2>
  <p class="subtitle">Persistencia en memoria · cálculo de IMC en el POST</p>

  {% if errors and errors|length %}
    <div class="alert alert-error">
      <strong>Errores del formulario:</strong>
      <ul>
        {% for e in errors %}
          <li>{{ e }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if result %}
    <div class="alert alert-success">
      <strong>Paciente creado correctamente.</strong>
      <div><b>ID:</b> {{ result.patient_id }}</div>
      <div><b>Nombre:</b> {{ result.display_name }}</div>
      <div><b>Edad:</b> {{ result.age_years }}</div>
      <div><b>Sexo al nacer:</b> {{ result.sex_at_birth }}</div>
      {% if result.bmi_last %}
        <div><b>IMC:</b> {{ result.bmi_last }} ({{ result.bmi_category_last }})</div>
      {% else %}
        <div><b>IMC:</b> No calculado (requiere altura y peso)</div>
      {% endif %}
    </div>
  {% endif %}

  <form action="/patients/create" method="post" novalidate class="grid-form">
    <label>
      <span>Nombre</span>
      <input name="first_name" required value="{{ form_data.first_name or '' }}" />
    </label>

    <label>
      <span>Apellido</span>
      <input name="last_name" required value="{{ form_data.last_name or '' }}" />
    </label>

    <label>
      <span>Fecha de nacimiento</span>
      <input type="date" name="date_of_birth" required value="{{ form_data.date_of_birth or '' }}" />
    </label>

    <label>
      <span>Sexo al nacer</span>
      <select name="sex_at_birth" required>
        {% set sx = form_data.sex_at_birth or '' %}
        <option value="" disabled {{ '' == sx and 'selected' or '' }}>Selecciona…</option>
        <option value="male"   {{ 'male'   == sx and 'selected' or '' }}>masculino</option>
        <option value="female" {{ 'female' == sx and 'selected' or '' }}>femenino</option>
        <option value="other"  {{ 'other'  == sx and 'selected' or '' }}>otro</option>
      </select>
    </label>

    <label>
      <span>Correo electrónico</span>
      <input type="email" name="email" placeholder="nombre@ejemplo.com" value="{{ form_data.email or '' }}" />
    </label>

    <label>
      <span>Teléfono</span>
      <input name="phone" placeholder="+34 600 000 000" value="{{ form_data.phone or '' }}" />
    </label>

    <label>
      <span>Altura (cm)</span>
      <input name="height_cm" inputmode="decimal" placeholder="Ej.: 174" value="{{ form_data.height_cm or '' }}" />
    </label>

    <label>
      <span>Peso (kg)</span>
      <input name="weight_kg" inputmode="decimal" placeholder="Ej.: 82.5" value="{{ form_data.weight_kg or '' }}" />
    </label>

    <label class="full checkbox">
      <input type="checkbox" name="consent_data_processing" {{ form_data.consent_data_processing and 'checked' or '' }}>
      <span>Acepto el consentimiento para el tratamiento de mis datos personales.</span>
    </label>

    <div class="actions full">
      <button type="submit" class="btn-primary">Registrar</button>
    </div>
  </form>
{% endblock %}

{% block scripts %}
  <script src="/static/js/patients_create.js" defer></script>
{% endblock %}
